name: Power BI Deploy (Main Branch)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository + LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Node.js (for pbicli)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pbicli globally
        run: npm install -g @powerbi-cli/powerbi-cli

      - name: Authenticate with Power BI (Service Principal)
        run: |
          pbicli login --service-principal \
            --principal "${{ secrets.CLIENT_ID }}" \
            --secret "${{ secrets.CLIENT_SECRET }}" \
            --tenant "${{ secrets.TENANT_ID }}"

      - name: Set Production Workspace ID
        run: |
          if [ -z "${{ secrets.PROD_WORKSPACE_ID }}" ]; then
            echo "Error: Secret PROD_WORKSPACE_ID is not set or empty" >&2
            exit 1
          fi
          echo "WORKSPACE_ID=${{ secrets.PROD_WORKSPACE_ID }}" >> $GITHUB_ENV
          echo "Using Production Workspace ID: ${{ secrets.PROD_WORKSPACE_ID }}"

      - name: Find PBIX file
        run: |
          pbix_file="Reports/Samplereport.pbix"
          if [ ! -f "$pbix_file" ]; then
            echo "Error: PBIX file not found at $pbix_file" >&2
            exit 1
          fi
          echo "pbix_files=$pbix_file" >> $GITHUB_ENV
          echo "Found PBIX file: $pbix_file"

      - name: Rename PBIX file (reponame-reportname.pbix)
        run: |
          file="${pbix_files}"
          dir=$(dirname "$file")
          base=$(basename "$file" .pbix)
          new_name="${{ github.event.repository.name }}-${base}.pbix"
          new_path="$dir/$new_name"
          mv "$file" "$new_path"
          echo "Renamed: $file → $new_path"
          echo "pbix_files=$new_path" >> $GITHUB_ENV

      - name: List existing reports and datasets in workspace
        run: |
          reports_json=$(pbicli report list --workspace "$WORKSPACE_ID" --output json)
          reports=$(echo "$reports_json" | jq -r '.[]?.name // empty' | tr '\n' ';')
          echo "reports=$reports" >> $GITHUB_ENV

          datasets_json=$(pbicli dataset list --workspace "$WORKSPACE_ID" --output json)
          datasets=$(echo "$datasets_json" | jq -r '.[]?.name // empty' | tr '\n' ';')
          echo "datasets=$datasets" >> $GITHUB_ENV

          echo "Reports in workspace:"
          echo "${reports:-None}" | tr ';' '\n'
          echo "Datasets in workspace:"
          echo "${datasets:-None}" | tr ';' '\n'

      - name: Publish PBIX file
        run: |
          echo "Publishing: $pbix_files"
          pbicli import pbix -w "$WORKSPACE_ID" --file "$pbix_files" --conflict CreateOrOverwrite

      - name: Delete orphaned reports and datasets
        run: |
          repo_prefix="${{ github.event.repository.name }}-"
          pbix_name=$(basename "$pbix_files" .pbix)

          # Orphaned reports
          echo "$reports" | tr ';' '\n' | while IFS= read -r report; do
            if [ -z "$report" ] || [[ ! "$report" == "$repo_prefix"* ]]; then continue; fi
            if [ "$report" != "$pbix_name" ]; then
              echo "Deleting orphaned report: $report"
              pbicli report delete --workspace "$WORKSPACE_ID" --report "$report" || true
            fi
          done

          # Orphaned datasets
          echo "$datasets" | tr ';' '\n' | while IFS= read -r ds; do
            if [ -z "$ds" ] || [[ ! "$ds" == "$repo_prefix"* ]]; then continue; fi
            if [ "$ds" != "$pbix_name" ]; then
              echo "Deleting orphaned dataset: $ds"
              pbicli dataset delete --workspace "$WORKSPACE_ID" --dataset "$ds" || true
            fi
          done

      - name: Rebind reports (if federated-model.txt exists)
        if: hashFiles('federated-model.txt') != ''
        run: |
          repo_prefix="${{ github.event.repository.name }}-"

          # Parse bindings (skip header, ignore comments)
          mapfile -t bindings < <(tail -n +2 federated-model.txt | grep -vE '^\s*(#|$)' | grep -E '^\s*[^:]+:[^:]+$')

          # Build dataset name → id map
          declare -A dataset_map
          while IFS= read -r line; do
            name=$(echo "$line" | jq -r '.name')
            id=$(echo "$line" | jq -r '.id')
            dataset_map["$name"]="$id"
          done < <(pbicli dataset list --workspace "$WORKSPACE_ID" --output json | jq -c '.[]')

          for line in "${bindings[@]}"; do
            report_raw=$(echo "$line" | cut -d':' -f1 | xargs)
            dataset_raw=$(echo "$line" | cut -d':' -f2- | xargs)
            report_name="${repo_prefix}${report_raw}"
            dataset_name="${repo_prefix}${dataset_raw}"

            if [ -z "${dataset_map[$dataset_name]}" ]; then
              echo "Error: Dataset '$dataset_name' not found. Skipping rebind."
              continue
            fi

            dataset_id="${dataset_map[$dataset_name]}"
            echo "Rebinding '$report_name' → '$dataset_name' (ID: $dataset_id)"
            pbicli report rebind --workspace "$WORKSPACE_ID" --report "$report_name" --target-dataset "$dataset_id" || echo "Rebind failed (may already be bound)"
          done
