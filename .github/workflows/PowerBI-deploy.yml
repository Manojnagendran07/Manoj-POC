name: Power BI CI/CD Deployment

on:
  push:
    branches:
      - main   # âœ… Trigger only on main branch

jobs:
  deploy-pbix:
    runs-on: windows-latest

    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      TENANT_ID: ${{ secrets.TENANT_ID }}
      DEV_WORKSPACE_ID: ${{ secrets.DEVWORKSPACEID }}
      PROD_WORKSPACE_ID: ${{ secrets.PROD_WORKSPACE_ID }}

    steps:
      - name: Install Modern Power BI CLI
        run: |
          npm uninstall -g powerbi-cli
          npm install -g @powerbi-cli/powerbi-cli
          pbicli version
        shell: powershell

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare PBIX Files
        run: |
          $absPath = "${{ github.workspace }}\pbix-temp"
          if (-not (Test-Path $absPath)) { New-Item -ItemType Directory -Path $absPath -Force }
          $allFiles = Get-ChildItem -Path "${{ github.workspace }}" -Filter *.pbix -Recurse
          foreach ($file in $allFiles) {
              $cleanName = ($file.BaseName -replace '[^a-zA-Z0-9]', '') + ".pbix"
              Copy-Item -Path $file.FullName -Destination (Join-Path $absPath $cleanName) -Force
          }
        shell: powershell

      - name: Login to Power BI
        run: |
          pbicli login --service-principal `
            --principal "${{ env.CLIENT_ID }}" `
            --secret "${{ env.CLIENT_SECRET }}" `
            --tenant "${{ env.TENANT_ID }}"
        shell: powershell

      - name: Deploy to Power BI Workspace Root
        run: |
          $branch = "${{ github.ref_name }}"
          $absPath = "${{ github.workspace }}\pbix-temp"

          # Since we only trigger on main, you can decide which workspace to use.
          # Example: deploy to PROD only
          $workspaceId = "${{ env.PROD_WORKSPACE_ID }}"

          $filesToDeploy = Get-ChildItem -Path "$absPath\*.pbix"

          if ($filesToDeploy.Count -eq 0) {
              Write-Error "No .pbix files found in $absPath to deploy!"
              exit 1
          }

          foreach ($file in $filesToDeploy) {
              Write-Host "----------------------------------------------"
              Write-Host "Target Workspace: $workspaceId (Branch: $branch)"
              Write-Host "Deploying File: $($file.Name)"

              pbicli import pbix `
                --workspace "$workspaceId" `
                --file "$($file.FullName)" `
                --name "$($file.BaseName)" `
                --conflict CreateOrOverwrite

              Write-Host "Successfully deployed $($file.Name) to the workspace root."
          }
        shell: powershell
